#include <LiquidCrystal.h>     // Satu library untuk kedua LCD Paralel
#include <EEPROM.h>

// --- Definisi PIN untuk SISTEM 1 dan SISTEM 2 ---

// Sistem 1 (LCD Paralel)
#define COIN_PIN_1 32       // Coin Acceptor 1
#define RELAY_PIN_1 25      // Relay 1

// PIN LCD PARALEL 16x2 untuk SISTEM 1 (Pin baru)
#define LCD_RS_1 15
#define LCD_EN_1 16
#define LCD_D4_1 17
#define LCD_D5_1 4
#define LCD_D6_1 0
#define LCD_D7_1 2

// Sistem 2 (LCD Paralel)
#define COIN_PIN_2 33       // Coin Acceptor 2
#define RELAY_PIN_2 26      // Relay 2

// PIN LCD PARALEL 16x2 untuk SISTEM 2 (Pin lama dari modifikasi sebelumnya)
#define LCD_RS_2 12
#define LCD_EN_2 13
#define LCD_D4_2 5
#define LCD_D5_2 18
#define LCD_D6_2 19
#define LCD_D7_2 23 


// Tombol (Satu set tombol untuk kontrol kedua sistem)
#define BUTTON_OK 14
#define BUTTON_UP 27
#define BUTTON_DOWN 2

// --- Definisi EEPROM ---
#define EEPROM_SIZE 16      
#define ADDR_DURASI_500_1 0 
#define ADDR_DURASI_1000_1 4
#define ADDR_DURASI_500_2 8 
#define ADDR_DURASI_1000_2 12

// --- Enumerasi dan Variabel Global ---

enum Mode { STANDBY,
             RUNNING,
             MENU,
             SET_500_1,
             SET_1000_1,
             SET_500_2,
             SET_1000_2,
             EXIT_MENU };

Mode mode = STANDBY;
int selectedMenu = 0;
const long MAX_WAKTU = 86400L; 

// --- Struktur Data untuk Setiap Sistem (2 set) ---
struct SystemData {
  LiquidCrystal *lcd; // Kini langsung menggunakan pointer LiquidCrystal
  int coinPin;
  int relayPin;
  volatile int coinPulseCount;
  volatile unsigned long lastCoinPulseTime;
  unsigned long totalWaktu_detik;
  unsigned long waktuMulai;
  bool isRunning;
  int durasi500;
  int durasi1000;
  String lastLine1;
  String lastLine2;
};

SystemData systems[2]; // Array untuk 2 sistem

// --- Prototipe Fungsi ---
void IRAM_ATTR detectCoin1();
void IRAM_ATTR detectCoin2();
void tampilLCD(int sysIndex, const String &line1, const String &line2);
void tambahWaktu(int sysIndex, int pulsa);
void handleMenu();
void settingDurasi(int sysIndex, int &durasi, const String &label, int addr);
void tampilMenu();


// --- Interupsi Coin Acceptor 1 & 2 (Sama) ---
void IRAM_ATTR detectCoin1() {
  unsigned long now = millis();
  if (now - systems[0].lastCoinPulseTime > 50) {
    systems[0].coinPulseCount++;
    systems[0].lastCoinPulseTime = now;
  }
}

void IRAM_ATTR detectCoin2() {
  unsigned long now = millis();
  if (now - systems[1].lastCoinPulseTime > 50) {
    systems[1].coinPulseCount++;
    systems[1].lastCoinPulseTime = now;
  }
}

// --- Fungsi Tampil LCD Universal (Sederhana karena Tipe LCD Sama) ---
void tampilLCD(int sysIndex, const String &line1, const String &line2) {
  if (line1 != systems[sysIndex].lastLine1 || line2 != systems[sysIndex].lastLine2) {
    
    systems[sysIndex].lcd->clear();
    systems[sysIndex].lcd->setCursor(0, 0);
    systems[sysIndex].lcd->print(line1);
    systems[sysIndex].lcd->setCursor(0, 1);
    systems[sysIndex].lcd->print(line2);
    
    systems[sysIndex].lastLine1 = line1;
    systems[sysIndex].lastLine2 = line2;
  }
}

// --- Fungsi Tambah Waktu Universal (Sama) ---
void tambahWaktu(int sysIndex, int pulsa) {
  int tambahDetik = 0;
  int durasi500 = systems[sysIndex].durasi500;
  int durasi1000 = systems[sysIndex].durasi1000;
  
  if (pulsa == 1) {
    tambahDetik = durasi500;
  } else if (pulsa >= 2 && pulsa <= 5) {
    tambahDetik = durasi1000;
  } else {
    return;
  }

  systems[sysIndex].totalWaktu_detik += tambahDetik;
  if (systems[sysIndex].totalWaktu_detik > MAX_WAKTU) systems[sysIndex].totalWaktu_detik = MAX_WAKTU;

  systems[sysIndex].waktuMulai = millis();
  systems[sysIndex].isRunning = true;
  digitalWrite(systems[sysIndex].relayPin, LOW);  // relay ON

  tampilLCD(sysIndex, "Koin Diterima!", "+" + String(tambahDetik / 60) + " Menit");
  delay(800);
  systems[sysIndex].lastLine1 = "";  // paksa LCD update
  systems[sysIndex].lastLine2 = "";
}

// --- Fungsi Tampil Menu Pengaturan (Sama) ---
void tampilMenu() {
  String line1, line2;
  
  int numMenus = 5;
  selectedMenu = (selectedMenu + numMenus) % numMenus;

  switch (selectedMenu) {
    case 0:
      line1 = "->SET 500 (Sistem 1)";
      line2 = "  SET 1000 (Sistem 1)";
      break;
    case 1:
      line1 = "  SET 500 (Sistem 1)";
      line2 = "->SET 1000 (Sistem 1)";
      break;
    case 2:
      line1 = "->SET 500 (Sistem 2)";
      line2 = "  SET 1000 (Sistem 2)";
      break;
    case 3:
      line1 = "  SET 500 (Sistem 2)";
      line2 = "->SET 1000 (Sistem 2)";
      break;
    case 4:
      line1 = "  SET 1000 (Sistem 2)";
      line2 = "->EXIT";
      break;
  }
  
  // Tampilkan menu di LCD Sistem 1 
  systems[0].lcd->clear();
  systems[0].lcd->setCursor(0, 0);
  systems[0].lcd->print(line1);
  systems[0].lcd->setCursor(0, 1);
  systems[0].lcd->print(line2);
  
  // Tampilkan informasi di LCD Sistem 2
  systems[1].lcd->clear();
  systems[1].lcd->setCursor(0, 0);
  systems[1].lcd->print("--- MENU UTAMA ---");
  systems[1].lcd->setCursor(0, 1);
  systems[1].lcd->print("Lihat LCD KIRI");
}

// --- Fungsi Handle Menu (Sama) ---
void handleMenu() {
  if (digitalRead(BUTTON_UP) == LOW) {
    delay(150);
    selectedMenu = (selectedMenu - 1 + 5) % 5;
    tampilMenu();
    while (digitalRead(BUTTON_UP) == LOW) ;
  }

  if (digitalRead(BUTTON_DOWN) == LOW) {
    delay(150);
    selectedMenu = (selectedMenu + 1) % 5;
    tampilMenu();
    while (digitalRead(BUTTON_DOWN) == LOW) ;
  }

  if (digitalRead(BUTTON_OK) == LOW) {
    delay(150);
    while (digitalRead(BUTTON_OK) == LOW) ;
    switch (selectedMenu) {
      case 0: mode = SET_500_1; break;
      case 1: mode = SET_1000_1; break;
      case 2: mode = SET_500_2; break;
      case 3: mode = SET_1000_2; break;
      case 4: mode = STANDBY; break;
    }
    systems[0].lcd->clear();
    systems[1].lcd->clear();
  }
}

// --- Fungsi Setting Durasi Universal (Sedikit Sederhana) ---
void settingDurasi(int sysIndex, int &durasi, const String &label, int addr) {
  int displayIndex = sysIndex + 1;
  
  char buf[17];
  sprintf(buf, "<- %2d m -> (OK)", durasi / 60);
  tampilLCD(sysIndex, "Set S" + String(displayIndex) + " " + label, buf);

  if (digitalRead(BUTTON_UP) == LOW) {
    delay(150);
    if (durasi < 3600) durasi += 60;
    while (digitalRead(BUTTON_UP) == LOW) ;
  }

  if (digitalRead(BUTTON_DOWN) == LOW) {
    delay(150);
    if (durasi > 60) durasi -= 60;
    while (digitalRead(BUTTON_DOWN) == LOW) ;
  }

  if (digitalRead(BUTTON_OK) == LOW) {
    delay(150);
    EEPROM.put(addr, durasi);
    EEPROM.commit();
    tampilLCD(sysIndex, "Tersimpan!", label + "=" + String(durasi / 60) + "m");
    delay(1000);
    mode = MENU;
    while (digitalRead(BUTTON_OK) == LOW) ;
  }
  
  // Tampilkan pesan di LCD yang tidak di setting
  int otherIndex = (sysIndex == 0) ? 1 : 0;
  systems[otherIndex].lcd->clear();
  systems[otherIndex].lcd->setCursor(0, 0);
  systems[otherIndex].lcd->print("Sistem " + String(displayIndex) + " di Set");
  systems[otherIndex].lcd->setCursor(0, 1);
  systems[otherIndex].lcd->print("Tunggu...");
}

// --- SETUP ---
void setup() {
  Serial.begin(115200);

  // Inisialisasi Data Sistem 1 (Paralel)
  systems[0].coinPin = COIN_PIN_1;
  systems[0].relayPin = RELAY_PIN_1;
  // Membuat objek LiquidCrystal untuk S1
  systems[0].lcd = new LiquidCrystal(LCD_RS_1, LCD_EN_1, LCD_D4_1, LCD_D5_1, LCD_D6_1, LCD_D7_1);

  // Inisialisasi Data Sistem 2 (Paralel)
  systems[1].coinPin = COIN_PIN_2;
  systems[1].relayPin = RELAY_PIN_2;
  // Membuat objek LiquidCrystal untuk S2
  systems[1].lcd = new LiquidCrystal(LCD_RS_2, LCD_EN_2, LCD_D4_2, LCD_D5_2, LCD_D6_2, LCD_D7_2);

  // Setup Pin Relay
  pinMode(RELAY_PIN_1, OUTPUT);
  digitalWrite(RELAY_PIN_1, HIGH);
  pinMode(RELAY_PIN_2, OUTPUT);
  digitalWrite(RELAY_PIN_2, HIGH);
  delay(100);

  // Setup Pin Coin Acceptor dan Interupsi
  pinMode(COIN_PIN_1, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(COIN_PIN_1), detectCoin1, FALLING);
  pinMode(COIN_PIN_2, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(COIN_PIN_2), detectCoin2, FALLING);

  // Setup Pin Tombol
  pinMode(BUTTON_OK, INPUT_PULLUP);
  pinMode(BUTTON_UP, INPUT_PULLUP);
  pinMode(BUTTON_DOWN, INPUT_PULLUP);
  
  // Setup Pin LCD Paralel S1 dan S2 (Semua pin yang digunakan)
  // Tidak perlu memanggil pinMode untuk setiap pin jika menggunakan ESP32/Arduino,
  // library LiquidCrystal akan mengurusnya melalui begin(). 
  
  // Inisialisasi LCD
  systems[0].lcd->begin(16, 2); 
  systems[1].lcd->begin(16, 2); 
  
  tampilLCD(0, "S1 Paralel PS ADS", "Memuat...");
  tampilLCD(1, "S2 Paralel PS ADS", "Memuat...");

  // Muat Durasi dari EEPROM
  EEPROM.begin(EEPROM_SIZE);
  EEPROM.get(ADDR_DURASI_500_1, systems[0].durasi500);
  EEPROM.get(ADDR_DURASI_1000_1, systems[0].durasi1000);
  EEPROM.get(ADDR_DURASI_500_2, systems[1].durasi500);
  EEPROM.get(ADDR_DURASI_1000_2, systems[1].durasi1000);

  // Validasi dan Simpan Default jika nilai tidak valid
  for (int i = 0; i < 2; i++) {
    if (systems[i].durasi500 < 60 || systems[i].durasi500 > 3600) systems[i].durasi500 = 6 * 60;
    if (systems[i].durasi1000 < 60 || systems[i].durasi1000 > 3600) systems[i].durasi1000 = 14 * 60;
  }
  EEPROM.put(ADDR_DURASI_500_1, systems[0].durasi500);
  EEPROM.put(ADDR_DURASI_1000_1, systems[0].durasi1000);
  EEPROM.put(ADDR_DURASI_500_2, systems[1].durasi500);
  EEPROM.put(ADDR_DURASI_1000_2, systems[1].durasi1000);
  EEPROM.commit();

  tampilLCD(0, "Sistem 1 Siap!", "Paralel");
  tampilLCD(1, "Sistem 2 Siap!", "Paralel");
  delay(1000);
}

// --- LOOP (Logika sama seperti sebelumnya) ---
void loop() {
  // --- Cek Tombol OK Lama (Menu) ---
  if ((mode == STANDBY || mode == RUNNING) && digitalRead(BUTTON_OK) == LOW) {
    unsigned long startPress = millis();
    while (digitalRead(BUTTON_OK) == LOW) ;
    if (millis() - startPress >= 2000) {
      if (systems[0].isRunning || systems[1].isRunning) {
        tampilLCD(0, "PERINGATAN S1!", "Masih BERJALAN!");
        tampilLCD(1, "PERINGATAN S2!", "Masih BERJALAN!");
        delay(1500);
      }
      mode = MENU;
      selectedMenu = 0;
      tampilMenu();
      return;
    }
  }

  // --- Cek Koin Sistem 1 ---
  if (systems[0].coinPulseCount > 0 && millis() - systems[0].lastCoinPulseTime > 300) {
    if (mode != MENU && mode != SET_500_1 && mode != SET_1000_1 && mode != SET_500_2 && mode != SET_1000_2) {
      noInterrupts();
      int pulsa = systems[0].coinPulseCount;
      systems[0].coinPulseCount = 0;
      interrupts();
      tambahWaktu(0, pulsa); // 0 = Sistem 1
    }
  }

  // --- Cek Koin Sistem 2 ---
  if (systems[1].coinPulseCount > 0 && millis() - systems[1].lastCoinPulseTime > 300) {
    if (mode != MENU && mode != SET_500_1 && mode != SET_1000_1 && mode != SET_500_2 && mode != SET_1000_2) {
      noInterrupts();
      int pulsa = systems[1].coinPulseCount;
      systems[1].coinPulseCount = 0;
      interrupts();
      tambahWaktu(1, pulsa); // 1 = Sistem 2
    }
  }

  switch (mode) {
    case STANDBY:
      tampilLCD(0, "Masukan Koin S1", "500=" + String(systems[0].durasi500 / 60) + "m 1K=" + String(systems[0].durasi1000 / 60) + "m");
      tampilLCD(1, "Masukan Koin S2", "500=" + String(systems[1].durasi500 / 60) + "m 1K=" + String(systems[1].durasi1000 / 60) + "m");
      break;

    case RUNNING:
      // Logika Waktu S1
      if (systems[0].isRunning) {
        unsigned long berjalan = (millis() - systems[0].waktuMulai) / 1000;
        long sisa = systems[0].totalWaktu_detik - berjalan;
        if (sisa <= 0) {
          sisa = 0;
          systems[0].isRunning = false;
          systems[0].totalWaktu_detik = 0;
          digitalWrite(RELAY_PIN_1, HIGH); 
          tampilLCD(0, "Waktu Habis S1", "Masukan Koin");
          delay(1500);
        } else {
          int m = sisa / 60;
          int d = sisa % 60;
          char buf[17];
          sprintf(buf, "%02d:%02d", m, d);
          tampilLCD(0, "S1 Sisa Waktu:", buf);
        }
      } else {
        tampilLCD(0, "Masukan Koin S1", "500=" + String(systems[0].durasi500 / 60) + "m 1K=" + String(systems[0].durasi1000 / 60) + "m");
      }

      // Logika Waktu S2
      if (systems[1].isRunning) {
        unsigned long berjalan = (millis() - systems[1].waktuMulai) / 1000;
        long sisa = systems[1].totalWaktu_detik - berjalan;
        if (sisa <= 0) {
          sisa = 0;
          systems[1].isRunning = false;
          systems[1].totalWaktu_detik = 0;
          digitalWrite(RELAY_PIN_2, HIGH); 
          tampilLCD(1, "Waktu Habis S2", "Masukan Koin");
          delay(1500);
        } else {
          int m = sisa / 60;
          int d = sisa % 60;
          char buf[17];
          sprintf(buf, "%02d:%02d", m, d);
          tampilLCD(1, "S2 Sisa Waktu:", buf);
        }
      } else {
        tampilLCD(1, "Masukan Koin S2", "500=" + String(systems[1].durasi500 / 60) + "m 1K=" + String(systems[1].durasi1000 / 60) + "m");
      }
      
      if (!systems[0].isRunning && !systems[1].isRunning) {
          mode = STANDBY;
      }
      break;
      
    case MENU:
      handleMenu();
      break;

    case SET_500_1:
      settingDurasi(0, systems[0].durasi500, "500", ADDR_DURASI_500_1);
      break;

    case SET_1000_1:
      settingDurasi(0, systems[0].durasi1000, "1000", ADDR_DURASI_1000_1);
      break;
      
    case SET_500_2:
      settingDurasi(1, systems[1].durasi500, "500", ADDR_DURASI_500_2);
      break;

    case SET_1000_2:
      settingDurasi(1, systems[1].durasi1000, "1000", ADDR_DURASI_1000_2);
      break;
  }

  delay(50);
}
